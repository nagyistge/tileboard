<!DOCTYPE html>
<meta charset="utf-8">
<style>
.board tr {
  display: block;
}

.board td {
  display: inline-block;
  position: relative;
  width: 64px;
  height: 64px;
  background: black;
  border-right: 1px solid white;
  border-bottom: 1px solid white;
  padding: 0;
}

.board img {
  position: absolute;
  top: 0px;
  left: 0px;
  width: 100%;
  height: 100%;
  z-index: 1;
}

.js-moving {
  transition-property: left, top;
  transition-duration: 1s, 1s;
  -webkit-transition-property: left, top;
  -webkit-transition-duration: 1s, 1s;
}
</style>
<title>Tileboard</title>
<h1>Tileboard</h1>
<script src="random-mover.js"></script>
<script>
"use strict";

var BOARD_WIDTH = 8;
var BOARD_HEIGHT = 8;

var MutationObserver = (window.MutationObserver ||
                        window.WebKitMutationObserver ||
                        window.MozMutationObserver);

function smoothifyMovement(table) {
  function endMovement() {
    if (this.classList.contains("js-moving")) {
      this.classList.remove("js-moving");
      this.style.left = null;
      this.style.top = null;
      ["style", "class"].forEach(function(attr) {
        if (this.hasAttribute(attr) && this.getAttribute(attr) === "")
          this.removeAttribute(attr);
      }, this);
    }
  }

  var observer = new MutationObserver(function(mutations) {
    var removed = [];
    var removedParents = [];

    mutations.forEach(function(m) {
      if (m.target.nodeName !== "TD")
        return;
      if (m.removedNodes && m.removedNodes.length)
        [].slice.call(m.removedNodes).forEach(function(node) {
          endMovement.call(node);
          removed.push(node);
          removedParents.push(m.target);
        });
      if (m.addedNodes && m.addedNodes.length) {
        [].slice.call(m.addedNodes).forEach(function(node) {
          var index = removed.indexOf(node);
          if (index != -1) {
            var prevRect = removedParents[index].getBoundingClientRect();
            var currRect = m.target.getBoundingClientRect();
            node.style.left = (prevRect.left - currRect.left) + "px";
            node.style.top = (prevRect.top - currRect.top) + "px";

            // Fix for Chrome to allow transitions to work properly.
            window.getComputedStyle(node).getPropertyValue("left");
            window.getComputedStyle(node).getPropertyValue("top");

            node.classList.add("js-moving");
            
            // This delay allows transitions to work properly on Firefox.
            setTimeout(function() {
              if (node.classList.contains("js-moving")) {
                node.style.left = null;
                node.style.top = null;
                node.addEventListener("transitionend", endMovement);
              }
            }, 50);
          }
        });
      }
    });
  });

  observer.observe(table, {
    subtree: true,
    childList: true
  });
  
  return observer;
}

window.addEventListener("DOMContentLoaded", function() {
  var LETTERS = "abcdefghijklmnopqrstuvwxyz";
  var table = document.createElement("table");
  var tiles = window.tiles = {};
  
  table.classList.add("board");
  document.body.appendChild(table);

  for (var y = 0; y < BOARD_HEIGHT; y++) {
    var row = document.createElement("tr");

    table.appendChild(row);
    
    for (var x = 0; x < BOARD_WIDTH; x++) {
      var td = document.createElement("td");
      var id = LETTERS[x] + (BOARD_HEIGHT - y);

      td.setAttribute("id", id);
      td.setAttribute("title", id);
      row.appendChild(td);
      tiles[id] = td;
    }
  }
  
  var smoothifyObserver = smoothifyMovement(table);
  
  var piece = document.createElement("img");
  piece.classList.add("random-mover");
  piece.src = "https://developer.cdn.mozilla.net/media/img/mdn-logo-sm.png";
  tiles.a1.appendChild(piece);
}, false);
</script>
<script src="zepto.js"></script>
